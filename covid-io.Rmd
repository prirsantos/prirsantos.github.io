---
title: "COVID-19 no Brasil"
author: "Pri"
date: "Última atualização em 28 de abril de 2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include = FALSE}

library(plotly)
library(orca)
library(zoo)
library(knitr)
library(htmlwidgets)

```

A ideia deste relatório é acompanhar a evolução do número de casos e de mortes por COVID-19 no Brasil, por meio dos dados oficiais do Ministério da Saúde, das Secretarias de Saúde estaduais e municipais e de outras fontes oficiais. Os dados estão sendo obtidos por meio dos sites oficiais e de outros repositórios abertos listados a seguir.

* [Brasil io](https://brasil.io/covid19/)

O país está com um grave problema de subnotificação de casos e óbitos, dada a dificuldade de importação, produção e processamento de testes. Assim, os gráficos a seguir mostram apenas parte do real cenário nacional cenário nacional, prejudicando as análises da situação nacional.

Os primeiros gráficos desta análise mostram a quantidade de casos confirmados e sua evolução em algumas cidades brasileiras. O primeiro gráfico (Fig. 01) mostra a evolução do número total de casos confirmados, desde o prmeiro caso registrado no Brasil, na cidade de São Paulo no dia 26/02.

Os dados apresetados mostram que a capital paulistana é a cidade com maior número de casos confirmados em todo o país. Contudo, ela também é a cidade mais populosa, o que faz com que seja natural ela ter mais casos do que outros municípios.



```{r include=FALSE}

#lista de cidades
minhas_cidades <- c('5300108', '2304400', '2704302', '1302603', '2611606', '3304557', '3550308', '2111300')

#Leitura do csv
cidades <- read.csv(file="io_todos.csv", stringsAsFactors = FALSE)
cidades <- subset(x = cidades , subset = (city_ibge_code %in% minhas_cidades))
cidades$date <- as.Date(cidades$date)
#str(cidades)


#gráfico de casos confirmados por cidade
x <- list(
  title = ""
)
y <- list(
  title = "Casos confirmados"
)

fig <- plot_ly(data = cidades, x = ~date, y = ~confirmed, color = ~city, type = 'scatter', mode = 'markers')
fig <- fig %>% layout(xaxis = x, yaxis = y)
```



```{r echo = FALSE, fig.cap= "**Fig. 01:** Evolução dos casos confirmados de COVID-19 em algumas cidades brasileiras."}
fig
```



Para tirar o feito do tamanho da população, é possível olharmos a quantidade proporcional de casos. A Figura 02, a seguir, apresenta a quantidade de cassos para cada 100 mil habitantes. Estes dados nos mostram que Fortaleza é a cidade acompanhada com uma situação mais preocupante. Nela, no dia 18 de abril, havia uma média de quase 80 casos para cada grupo de 100 mil habitantes, enquanto em São Paulo eram aproximadamente 65 casos confirmados para cada grupo de 100 mil pessoas. Ao observar a proporção de casos a cada 100 mil habitantes, a cidade de Manaus salta aos olhos, com um rápido aumento de casos.

```{r include=FALSE}
#gráfico de casos confirmados por por 100k habitantes por cidade
x <- list(
  title = ""
)
y <- list(
  title = "Casos confirmados por 100 mil habitantes"
)

fig02 <- plot_ly(data = cidades, x = ~date, y = ~confirmed_per_100k_inhabitants, color = ~city, type = 'scatter', mode = 'markers')
fig02 <- fig02 %>% layout(xaxis = x, yaxis = y)
```

```{r echo = FALSE, fig.cap= "**Fig. 02:** Evolução da proporção de casos confirmados de COVID-19 por 100 mil habitantes, em algumas cidades brasileiras."}
fig02
```

Tanto no gráfico geral de casos (Fig. 01) quanto no proporcional (Fig 02), Maceió é a cidade acompanhada que está com a melhor cituação. A quantidade de casos está baixa e não preocupa por enquanto.




```{r include=FALSE}

#gráfico de casos confirmados por cidade
x <- list(
  title = ""
)
y <- list(
  title = "Mortes confirmadas ou suspeitas"
)

fig <- plot_ly(data = cidades, x = ~date, y = ~deaths, color = ~city, type = 'scatter', mode = 'markers')
fig <- fig %>% layout(xaxis = x, yaxis = y)
```



```{r echo = FALSE, fig.cap= "**Fig. 03:** Evolução das mortes confirmadas ou suspeitas de COVID-19 em algumas cidades brasileiras."}
fig
```


```{r echo = FALSE}
#for dos subsets de cicades
lista_cidade <- split(cidades, f = cidades$city_ibge_code)
lista_cidade <- lapply(lista_cidade, function(filtro_cidade){
  # filtro_cidade <- lista_cidade[[1]]
  
  #calcula o total de novos casos confirmados por dia
  total_linhas <- nrow(filtro_cidade)
  filtro_cidade$caso_dia <- NA
  filtro_cidade$caso_dia[1:(total_linhas-1)] <- filtro_cidade$confirmed[1:(total_linhas-1)]-
    filtro_cidade$confirmed[2:total_linhas]
  filtro_cidade$caso_dia[total_linhas] <- filtro_cidade$confirmed[total_linhas]

  
  #cálculo da média móvel de 7 dias 
  filtro_cidade$media_caso_dia <- NA
  filtro_cidade$media_caso_dia <- c(rollmean(x = filtro_cidade$caso_dia, k = 7), 
                                    filtro_cidade$caso_dia[(total_linhas-5):total_linhas])
  
  
  #calcula o total de novas moster por dia
  #total_linhas <- nrow(filtro_cidade)
  filtro_cidade$mortes_dia <- NA
  filtro_cidade$mortes_dia[1:(total_linhas-1)] <- filtro_cidade$deaths[1:(total_linhas-1)]-
    filtro_cidade$deaths[2:total_linhas]
  filtro_cidade$mortes_dia[total_linhas] <- filtro_cidade$deaths[total_linhas]

  
  #cálculo da média móvel de 7 dias 
  filtro_cidade$media_mortes_dia <- NA
  filtro_cidade$media_mortes_dia <- c(rollmean(x = filtro_cidade$mortes_dia, k = 7), 
                                    filtro_cidade$mortes_dia[(total_linhas-5):total_linhas])
  
  
  return(filtro_cidade)
})
cidades <- do.call(rbind, lista_cidade)



lista_cidade <- split(cidades, f = cidades$city_ibge_code)
htmltools::tagList(lapply(lista_cidade, function(filtro_cidade){
  # filtro_cidade <- lista_cidade[[1]]
  
  #gráfico de novos casos confirmados por dia por cidade
  x <- list(
    title = ""
  )
  y <- list(
    title = "Novos casos confirmados por dia"
  )
  
  
  plot_ly(data = filtro_cidade[filtro_cidade$caso_dia>0,], x = ~date, y = ~caso_dia, 
          name = 'casos novos por dia', type = 'bar') %>% 
    add_trace(y = ~mortes_dia, name = 'Mortes por dia') %>% 
    layout(xaxis = x, yaxis = y, title=filtro_cidade$city[1])

}))


```


```{r include=FALSE}
#gráfico de casos confirmados por por 100k habitantes por cidade
x <- list(
  title = ""
)
y <- list(
  title = "Taxa de mortalidade"
)

fig02 <- plot_ly(data = cidades, x = ~date, y = ~death_rate, color = ~city, type = 'scatter', mode = 'line')
fig02 <- fig02 %>% layout(xaxis = x, yaxis = y)
```

```{r echo = FALSE, fig.cap= "**Fig. 05:** Evolução da taxa de mortalidade por COVID-19, em algumas cidades brasileiras."}
fig02
```


O quarto gráfico deste relatório (Fig. 04) traz uma outra perspectiva da evolução dos casos confirmados. O eixo y (eixo vertical) é possível verificar os valores de média móvel de 7 dias de novos casos confirmados, isto é cada ponto representa a média dos cinco dias anteriores (por exemplo, o primeiro ponto é a média de novos casos entre o 1º e o 5º dia, o segundo ponto é a média de novos casos entre o 2º e o 6º dia, o terceiro ponto é a média entre o 3º e o 7º dias e assim sucessivamente). No eixo x (eixo horizontal) é possível verificar a quantidade total de casos. O gráfico mostra uma linha reta por estar em escala logarítmica nos dois eixos (gráfico log-log). A ideia é que quando atingirmos o ponto de máximo e a quantidade de casos passar a se estabilizar o gráfico deixará de mostrar uma reta e passará a mostrar uma queda abrupta. Esta ideia é bem explicada no vídeo do canal MinutePhysics[^1]. Gráficos similares de outros países do mundo foram produzidos por Aatish Bhatia [^2]. 

[^1]: O [vídeo](https://www.youtube.com/watch?feature=youtu.be&v=54XLXg4fYsc&app=desktop) está em inglês, mas tem legendas em português 
[^2]: [COVID Trends](https://aatishb.com/covidtrends/)

Como dito anteriormente, a partir do gráfico da Figura 02 é possível observar a evolução do número de novos casos confirmados por dia versus a quantidade total de casos confirmados. Este gráfico não mostra uma evolução temporal e por isso estar para trás ou para frente está relacionado à quantidade total de casos e não ao número de dias com casos confirmados. O que ele evidencia é que a epidemia em São Paulo e no restante do país, desde os primeiros casos vem evoluindo de forma muito parecida, com curvas muito próximas umas das outras, o que significa que a escala logarítmica na qual os novos casos aparecem é parecida em todo o país. O que está de acordo com os dados publicados por Aatish Bhatia, que mostra todos os países evoluindo numa mesma escala de propagação da epidemia. Assim como no gráfico da Figura 01, os dados entre o 30º e 0 35º dia pareciam mostrar uma mudança para uma queda abrupta, contudo os dados dos últimos dois dias reforçam a ideia de que São Paulo continua com um aumento de casos na mesma velocidade de antes e do resto do país. No gráfico da Figura 02 essas ideia se mostra na medida que todos os dados sem mantém em retas muito similares. 



```{r include = FALSE}
#gráfico di-log da média móvel de 7 dias de novos casos por dia pelo total de casos
fig04 <- plot_ly(data = cidades[cidades$confirmed>10,], x = ~confirmed, y = ~media_caso_dia, color = ~city, 
                 type = 'scatter', mode = 'line')
fig04 <- fig04 %>% layout(xaxis = list(type = "log", title = "Total de casos confirmados"), 
                          yaxis = list(type = "log", title = "Média de novos casos confirmados por dia"))
```

```{r echo = FALSE, fig.cap= "**Fig. 04:** Dados da média móvel da confirmação de novos casos diários contra a quantidade total de casos confirmados de COVID-19 no Brasil."}
fig04
#orca(fig04, file = "04-media_movel_casos_dia.png")

```



